---
title: Django Postgres Collate
tags:
    - django
    - postgres
publish: true
---

# Django Postgres Collate

Postgres를 사용할 때, [[collate]]를 별도로 설정하지 않으면 `order_by()`로 한글이 포함된 컬럼 정렬 시 이상하게 정렬이 된다.

이미 DB가 운영중이라 DB 중단을 할 수 없을 때, 쿼리셋의 `order_by` 메소드를 오버라이드 하여 특정 필드에서 collate order by를 걸 수 있다. 이 경우 DRF의 filter order_by를 그대로 쓸 수 있다.

```python
class TableQuerySet(QuerySet):
    collate_fields = ["name"]

    def _get_collate_func(self, field_name):
        return Func(
            field_name, function="ko_KR.UTF-8", template='(%(expressions)s) COLLATE "%(function)s"'
        )

    def order_by(self, *field_names):
         ordering_fields = []
         for field_name in field_names:
             descending = field_name.startswith("-")
             pure_field_name = field_name[1:] if descending else field_name

             if pure_field_name not in self.collate_fields:
                 ordering_fields.append(field_name)
                 continue

             collate_func = self._get_collate_func(pure_field_name)
             if descending:
                 ordering_fields.append(collate_func.desc())
             else:
                 ordering_fields.append(collate_func.asc())
         return super().order_by(*ordering_fields)
```

[//begin]: # "Autogenerated link references for markdown compatibility"
[collate]: ../../../server/db/postgres/collate.md "Collate"
[//end]: # "Autogenerated link references"