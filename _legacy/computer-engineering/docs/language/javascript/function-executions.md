# Javascript Function Executions

## 1. Call Stack

함수의 호출을 기록하는 자료구조로 function을 실행시키면 stack에 쌓이고, 함수 실행이 끝나면 pop 되게 된다.

크롬 브라우저는 16,000개의 콜 스택을 가지고 있어 이 범위를 벗어나면 Max Stack Error Reached 상태가 된다.

## 2. Heap

오브젝트들은 힙 내부에 할당된다. 힙은 unstructured 메모리로 변수와 객체의 모든 메모리 할당이 여기서 이루어 지게 된다.

## 3. Queue

자바스크립트 런타임은 메세지 큐를 갖고 있다. 메세지 큐는 실행될 콜백 함수나 메시지들에 대한 리스트이다.  
스택에 충분한 capacity를 갖고 있을 때 메세지는 큐 밖에 나오게 되고, 메세지가 갖고있던 함수 목록이 실행되게 된다. 이렇게 초기 스택 프레임이 만들어진다.
스택이 다시 빌 때 메세지 수행도 끝나게 된다.

이벤트들에 대한 콜백 함수가 제공된다고 가정했을 때, 이 메시지들은 외부 비동기 이벤트들에 대한 응답으로 큐에 쌓인다.

외부 비동기 이벤트란 마우스 클릭, HTTP 요청 등을 말한다.  
사용자가 버튼을 눌렀을 때 아무런 콜백 함수가 등록되어있지 않다면 어떠한 메세지도 큐에 들어가지 않을 것이다.

## 4. Event loop

스택을 계속 차지하고 있는 함수를 'Blocking Script'라고 부른다.

만일 블로킹 스크립트가 작업을 처리하는 중에 다른 비동기 요청이 들어올 경우 싱글 스레드인 자바스크립트는 아무것도 할 수 없다. 스택에 쌓인 함수들에서 어떠한 값을 반환하기 전까지 불가능하다.

가장 쉬운 해결책은 비동기 함수를 사용하는 것이다. 비동기 콜백을 사용하는 것은 코드의 일정 부분을 실행시키고, 나중에 실행될 콜백 함수를 스택에 넣는 것을 말한다.

비동기 함수는 동기 함수들과 다르게 스택의 내부로 바로 push 할 수 없다.

응답(response)에서 호출자(caller) 분리는 자바스크립트 런타임이 비동기 명령이 완료되고 콜백이 호출될 때 까지 기다리는 동안 다른 일을 하는 것을 허용한다.

* 몽키패치(강제로 오버라이딩 하여 프로그램의 행동을 바꾸는 것)

실행중인 코드가 끝난다면 콜백을 큐에 넣는다. 이벤트 루프는 큐 안의 콜백들을 스택이 비었을 때 밀어넣는 일을 담당한다. 이벤트 루프가 하는 기본적인 일 중 하나는 스택과 작업 큐를 보고, 스택이 비었을 때 큐 첫번째에 있는 스택에 밀어넣는 일을 한다.

자바스크립트는 싱글 스레드이기 때문에, 추가적인 폴링 중 메시지와 프로세싱은 잠시 중단되고, 스택에 있는 모든 호출들의 return을 기다린다. 그리고 동기함수들은 스택에 새로운 콜 프레임을 추가한다.

<https://velog.io/@jakeseo_me/2019-03-15-2303-작성됨-rmjta5a3xh>
